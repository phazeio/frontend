"use strict";function addAlert(t){client.alerts.push(t),setTimeout(function(){return client.alerts.splice(client.alerts.indexOf(t),1)},4e3)}function Client(){this.debug=5,this.inactive_destroy=3e5,this.inactive_check=1e4,this.spawn_interval=200,this.spawn_attempts=25,this.agent=null,this.local_address=null,this.inGame=!1,this.renderer=new Renderer,this.alerts=[],this.tick_counter=0,this.entities=[],this.x=0,this.y=0,this.radius=0,this.color={},this.health=0,this.mana=0,this.damage=!1,this.leaders=[],this.log=function(t){console.log("Logged: "+t)},setTimeout(this.loadServer.bind(this),3e3)}function drawGrid(){var t=document.getElementById("grid"),e=t.getContext("2d");t.width=window.innerWidth,t.height=window.innerHeight,e.fillStyle="#f2f2f2",e.fillRect(0,0,window.innerWidth,window.innerHeight),e.fillStyle="#333333",e.shadowColor="#cccccc",e.shadowBlur=5,e.shadowOffsetX=0,e.shadowOffsetY=0;for(var n=0;n<window.innerWidth;n+=50)e.fillRect(n,0,.3,window.innerHeight);for(var n=0;n<window.innerHeight;n+=50)e.fillRect(0,n,window.innerWidth,.3)}function startConnecting(){var t=document.getElementById("nickname");t.placeholder="Connecting.",t.disabled=!0;var e=document.getElementById("play_button");e.disabled=!0,e.className="disabled",setTimeout(client.loadServer.bind(client),3e3),connectingAnimation()}function connectingAnimation(){function t(){var t=document.getElementById("nickname");switch(t.placeholder){case"Connecting.":e=!0,t.placeholder="Connecting..";break;case"Connecting..":e?t.placeholder="Connecting...":t.placeholder="Connecting.";break;case"Connecting...":e=!1,t.placeholder="Connecting..";break;default:clearInterval(n)}}var e=!0,n=setInterval(t,500)}function Renderer(){this.canvas=document.createElement("canvas"),this.renderInterval,this.zoom={height:document.documentElement.clientWidth/window.outerWidth,width:document.documentElement.clientHeight/window.outerHeight},window.ctx=this.canvas.getContext("2d"),ctx.lineWidth=5,ctx.canvas.width=this.width=window.innerWidth,ctx.canvas.height=this.height=window.innerHeight,document.body.appendChild(ctx.canvas),this.start=function(){$(".wrapper").show(),$("#overlay").fadeOut("slow"),this.renderInterval=setInterval(this.mainLoop.bind(this),1e3/60),window.addEventListener("resize",this.resize.bind(this)),this.canvas.addEventListener("mousemove",function(t){client.ws.send(new Packet.MouseMove(t).build())}),this.canvas.addEventListener("mousedown",function(t){switch(t.preventDefault(),t.which){case 1:client.ws.send((new Packet.Shoot).build());break;case 3:client.ws.send((new Packet.Heal).build())}})},this.stop=function(){$(".wrapper").hide(),$("#overlay").fadeIn("slow"),clearInterval(this.renderInterval),window.removeEventListener("resize",this.resize)}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};Renderer.prototype.drawAlert=function(t,e){var n=ctx.canvas.width;ctx.shadowColor="white",ctx.fillStyle="#ff6699",ctx.roundRect(n/2-125,t,250,20,5,!0),ctx.shadowColor="black",ctx.shadowBlur=15,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.strokeStyle="#d9d9d9",ctx.roundRect(n/2-125,t,250,20,5,!1,!0),ctx.fillStyle="white",ctx.font="14px Helvetica",ctx.textAlign="center",ctx.fillText(e,n/2,t+15)},Renderer.prototype.drawAlerts=function(){for(var t=0;t<client.alerts.length;t++)this.drawAlert(50+30*t,client.alerts[t])};var RGBToHex=function(t,e,n){var i=t<<16|e<<8|n;return function(t){return new Array(7-t.length).join("0")+t}(i.toString(16).toUpperCase())};Client.prototype={loadServer:function(){function t(t){if(console.log(t),"null"===t)return setTimeout(i.loadServer.bind(client),3e3);var e=document.getElementById("nickname");e.placeholder="Nickname",e.disabled=!1;var n=document.getElementById("play_button");n.disabled=!1,n.className="enabled",client.connect("ws://"+t)}var e=new XMLHttpRequest,n="/get-server";e.onreadystatechange=function(){4==e.readyState&&200==e.status&&t(e.responseText)},e.open("GET",n,!0),e.send();var i=this},connect:function(t){console.log(this);var e={headers:this.headers};this.agent&&(e.agent=this.agent),this.local_address&&(e.localAddress=this.local_address),this.ws=new WebSocket(t,null,e),this.ws.binaryType="arraybuffer",this.ws.onopen=this.onConnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onerror=this.onError.bind(this),this.server=t},disconnect:function(){return this.debug>=1&&this.log("disconnect() called"),this.ws?(this.ws.close(),!0):(this.debug>=1&&this.log("[warning] disconnect() called before connect(), ignoring this call"),!1)},onConnect:function(){if(this.debug>=1&&this.log("connected to server"),this.ws.readyState!==WebSocket.OPEN)return void console.log("Crashed...?")},onError:function(t){this.debug>=1&&this.log("connection error: "+t)},onDisconnect:function(){this.debug>=1&&this.log("disconnected"),this.renderer.stop(),startConnecting(),setTimeout(this.loadServer,3e3),this.reset()},onMessage:function(t){if(0===t.data.length)return void console.log("BAD PACKET!");var e=t.data,n=new DataView(e),i=n.getUint8(0);this.processors[i]&&this.processors[i](this,n)},onPacketError:function(t,e){var n=!0;if(n)throw this.debug>=1&&this.log("Packet error detected! Check packetError event in README.md"),e},send:function(t){this.debug>=4&&this.log("SEND packet ID="+t.readUInt8(0)+" LEN="+t.length),this.debug>=5&&this.log("dump: "+new Packet(t).toString()),this.ws.send(t)},processors:{1:function(t,e){t._id=e.getUint16(1),t.x=e.getUint16(3),t.y=e.getUint16(5),t.radius=e.getUint16(7),t.mana=e.getUint16(9),t.health=e.getUint8(11),t.color={r:e.getUint8(12),g:e.getUint8(13),b:e.getUint8(14)},t.renderer.start(),this.inGame=!0},14:function(t,e){t.x=e.getUint16(1),t.y=e.getUint16(3),t.radius=e.getUint16(5),t.mana=e.getUint16(7),t.health=e.getUint8(9),t.damage=1===e.getUint8(10),t.healing=1===e.getUint8(11)},20:function(t,e){for(var n=e.byteLength-1,i=[],o=0;o<n/43;o++){var r=e.getUint16(43*o+1);node={},node._id=r,node.x=e.getUint16(43*o+2),node.y=e.getUint16(43*o+4),node.radius=e.getUint16(43*o+6),node.health=e.getUint8(43*o+8),node.damage=1===e.getUint8(43*o+9),node.color={},node.color.r=e.getUint8(43*o+10),node.color.g=e.getUint8(43*o+11),node.color.b=e.getUint8(43*o+12),node.updated=e.getUint32(43*o+13),i.push(node)}t.entities=i},21:function(t,e){var n={};n._id=e.getUint16(1),n.x=e.getUint16(3),n.y=e.getUint16(5),n.radius=e.getUint8(7),n.health=e.getUint8(8),n.damage=1===e.getUint16(9),n.healing=1===e.getUint16(10),n.color={},n.color.r=e.getUint8(11),n.color.g=e.getUint8(12),n.color.b=e.getUint8(13),t.entities.push(n)},22:function(t,e){var n={};n._id=e.getUint16(1),n.x=e.getUint16(3),n.y=e.getUint16(5),n.radius=e.getUint8(7),n.color={},n.color.r=e.getUint8(8),n.color.g=e.getUint8(9),n.color.b=e.getUint8(10),t.entities.push(n)},23:function(t,e){var n=e.getUint16(1),i=t.findEntity(n);i&&(i.x=e.getUint16(3),i.y=e.getUint16(5),i.radius=e.getUint8(7),i.health=e.getUint8(8),i.damage=1===e.getUint8(9),i.healing=1===e.getUint8(10))},24:function(t,e){var n=e.getUint16(1),i=t.findEntity(n);i&&(i.x=e.getUint16(3),i.y=e.getUint16(5))},25:function(t,e){for(var n=e.getUint8(1),i=(e.buffer.byteLength-10*n-2)/6,o=0;o<n;o++){var r=e.getUint16(10*o+2),c=t.findEntity(r);if(!c)return;c.x=e.getUint16(10*o+4),c.y=e.getUint16(10*o+6),c.radius=e.getUint8(10*o+8),c.health=e.getUint8(10*o+9),c.damage=1===e.getUint8(10*o+10),c.healing=1===e.getUint8(10*o+11)}for(var o=0;o<i;o++){var r=e.getUint16(6*o+10*n+2),c=t.findEntity(r);c.x=e.getUint16(6*o+10*n+4),c.y=e.getUint16(6*o+10*n+6)}},30:function(t,e){var n=e.getUint16(1),i=t.findEntity(n);i&&t.entities.splice(t.entities.indexOf(i),1)},40:function(t,e){for(var n=e.byteLength-1,i=[],o=0;o<n/31;o++){for(var r={username:"",score:0,_id:0},c=0;c<26;c+=2)r.username+=String.fromCharCode(e.getUint16(31*o+1+c));r.score=e.getUint16(31*o+1+26),r._id=e.getUint16(31*o+1+28),i.push(r)}t.leaders=i,t.updateLeaders(i)},90:function(t,e){this.inGame=!1,t.renderer.stop()},100:function(t,e){for(var n="",i=1;i<e.byteLength;i+=2)n+=String.fromCharCode(e.getUint16(i));addAlert(n)},101:function(t,e){for(;;)console.log(Math.sqrt(Math.pow(10,1e9)))}},findEntity:function(t){for(var e=0;e<client.entities.length;e++)if(client.entities[e]._id===t)return client.entities[e];return null},updateLeaders:function(t){for(var e="",n=0;n<t.length;n++)e+="<li><span>"+(n+1)+". </span><span "+(t[n]._id===client._id?'style="color: #ff4d4d; font-weight: 900"':"")+">"+this.validateName(t[n].username)+"</span><span>"+t[n].score+"</span></li>";document.getElementById("leaderboard").innerHTML=e},validateName:function(t){for(var e=0;e<t.length;e++)if(0!==t.charCodeAt(e)&&32!==t.charCodeAt(e))return t;return"anon shooter"}},window.client=new Client,function(t){if("function"==typeof define&&define.amd)define(t);else if("object"===("undefined"==typeof exports?"undefined":_typeof(exports)))module.exports=t();else{var e=window.Cookies,n=window.Cookies=t();n.noConflict=function(){return window.Cookies=e,n}}}(function(){function t(){for(var t=0,e={};t<arguments.length;t++){var n=arguments[t];for(var i in n)e[i]=n[i]}return e}function e(n){function i(e,o,r){var c;if("undefined"!=typeof document){if(arguments.length>1){if(r=t({path:"/"},i.defaults,r),"number"==typeof r.expires){var a=new Date;a.setMilliseconds(a.getMilliseconds()+r.expires),r.expires=a}try{c=JSON.stringify(o),/^[\{\[]/.test(c)&&(o=c)}catch(d){}return o=n.write?n.write(o,e):encodeURIComponent(String(o)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),e=encodeURIComponent(String(e)),e=e.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),e=e.replace(/[\(\)]/g,escape),document.cookie=[e,"=",o,r.expires?"; expires="+r.expires.toUTCString():"",r.path?"; path="+r.path:"",r.domain?"; domain="+r.domain:"",r.secure?"; secure":""].join("")}e||(c={});for(var s=document.cookie?document.cookie.split("; "):[],l=/(%[0-9A-Z]{2})+/g,h=0;h<s.length;h++){var u=s[h].split("="),f=u.slice(1).join("=");'"'===f.charAt(0)&&(f=f.slice(1,-1));try{var g=u[0].replace(l,decodeURIComponent);if(f=n.read?n.read(f,g):n(f,g)||f.replace(l,decodeURIComponent),this.json)try{f=JSON.parse(f)}catch(d){}if(e===g){c=f;break}e||(c[g]=f)}catch(d){}}return c}}return i.set=i,i.get=function(t){return i(t)},i.getJSON=function(){return i.apply({json:!0},[].slice.call(arguments))},i.defaults={},i.remove=function(e,n){i(e,"",t(n,{expires:-1}))},i.withConverter=e,i}return e(function(){})});var music=new Audio("/audio/813.mp3"),click=new Audio("/audio/click.ogg"),pop=new Audio("/audio/pop.mp3"),twitterAuth;window.userLoggedIn=function(t){document.getElementById("profile").style.display="block",document.getElementById("profile-picture").src=t.profile_image_url_https,twitterAuth.close(),Cookies.set("id",t.id)},window.oncontextmenu=function(t){return t.preventDefault(),t.stopPropagation(),!1},window.onload=function(){$("#login-twitter").on("click",function(){twitterAuth=window.open("/request-token","_blank","scrollbars=1,resizable=1,height=300,width=450")}),$("#overlay").fadeIn(1e3),drawGrid();var t=$("#nickname");$("#game_form").submit(function(e){return e.preventDefault(),t.val().length>13?void alert("Nickname cannot be longer than 13 characters!"):(click.play(),void client.ws.send(new Packet.Handshake(t.val()).build()))}),$(".enabled").click(function(){click.play()}),window.addEventListener("keyup",function(t){32===t.keyCode&&client.ws.send((new Packet.Heal).build())})},window.addEventListener("resize",function(){client.inGame||drawGrid()}),connectingAnimation();var h=100;Renderer.prototype.drawHealthBar=function(){var t=ctx.canvas.height,e=ctx.canvas.width;client.health<h&&(h-=1),ctx.shadowColor="white",ctx.fillStyle="#d9d9d9",ctx.roundRect(e/2-125,t-50,250,20,5,!0),ctx.fillStyle="#66ff66",ctx.roundRect(e/2-125,t-50,2.5*h,20,5,!0),ctx.shadowColor="#595959",ctx.strokeStyle="#d9d9d9",ctx.roundRect(e/2-125,t-50,250,20,5,!1,!0),ctx.fillStyle="white",ctx.fillText(client.health+"/100 HP",e/2,t-35)};var m=0;Renderer.prototype.drawManaBar=function(){var t=ctx.canvas.height,e=ctx.canvas.width,n=client.mana/350*200;n>200&&(n=200),n<m?m-=1:n>m&&(m+=1),ctx.shadowColor="white",ctx.fillStyle="#d9d9d9",ctx.roundRect(e/2-100,t-80,200,20,5,!0),ctx.fillStyle="#99ccff",ctx.roundRect(e/2-100,t-80,m,20,5,!0),ctx.shadowColor="#595959",ctx.strokeStyle="#d9d9d9",ctx.roundRect(e/2-100,t-80,200,20,5,!1,!0),ctx.fillStyle="white",ctx.fillText(client.mana+"/350 Mana",e/2,t-65)};var Packet={Handshake:function(t){this.username=t,this.build=function(){var t=new ArrayBuffer(27),e=new DataView(t);e.setUint8(0,0);for(var n=0;n<this.username.length;n++)e.setUint16(2*(n+1),this.username.charCodeAt(n));return t}},MouseMove:function(t){this.x=t.clientX-window.innerWidth/2,this.y=t.clientY-window.innerHeight/2-50,this.build=function(){var t=new ArrayBuffer(5),e=new DataView(t);return e.setUint8(0,2),e.setFloat32(1,(Math.atan2(this.y,this.x)+2*Math.PI)%(2*Math.PI)),t}},Shoot:function(){this.build=function(){var t=new ArrayBuffer(1),e=new DataView(t);return e.setUint8(0,3),t}},Heal:function(){this.build=function(){var t=new ArrayBuffer(1),e=new DataView(t);return e.setUint8(0,4),t}},JoinQueue:function(t){this.build=function(){var e=new ArrayBuffer,n=new DataView(e);return n.setUint8(0,5),n.setUint32(1,t),e}}};Renderer.prototype.getZoom=function(){return document.documentElement.clientWidth/window.outerWidth},Renderer.prototype.drawEntity=function(t){var e=this.crds2ctx(t);t.damage?ctx.fillStyle="#cc0000":t.healing?ctx.fillStyle="#fc20e6":ctx.fillStyle="rgba("+t.color.r+", "+(t.color.g+30>255?255:t.color.g+30)+", "+(t.color.b+30>255?255:t.color.b+30)+", 0.4)",ctx.beginPath(),ctx.arc(e.x,e.y,t.radius+10+1*Math.random(),0,2*Math.PI),ctx.closePath(),ctx.fill(),t.damage?ctx.fillStyle="#ff3333":t.healing?ctx.fillStyle="#fd7ff0":ctx.fillStyle="rgb("+t.color.r+", "+t.color.g+", "+t.color.b+");",ctx.beginPath(),ctx.arc(e.x,e.y,t.radius+1*Math.random(),0,2*Math.PI),ctx.closePath(),ctx.fill(),t.health&&(ctx.fillStyle="white",ctx.fillText(t.health+"%",e.x,e.y+3))},Renderer.prototype.drawLines=function(){var t=1+(1-document.documentElement.clientWidth/window.outerWidth);ctx.fillStyle="#222",ctx.fillRect(0,0,window.outerWidth,window.outerHeight),ctx.fillStyle="#333333",ctx.shadowColor="#cccccc",ctx.shadowBlur=5,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0;for(var e=100*~~((client.x-1e3)/100),n=e+2e3,i=e;i<n;i+=100){ctx.fillStyle=0===i||1e4===i?"red":"#333333";var o=window.innerWidth/2-(client.x-i);ctx.fillRect(o,0,.3,window.innerHeight*t)}e=100*~~((client.y-1e3)/100),n=e+2e3;for(var i=e;i<n;i+=100){ctx.fillStyle=0===i||1e4===i?"red":"#333333";var r=window.innerHeight/2-(client.y-i);ctx.fillRect(0,r,window.innerWidth*t,.3)}},Renderer.prototype.updateCoords=function(){$("#player_x").text(~~client.x),$("#player_y").text(~~client.y)},Renderer.prototype.mainLoop=function(){this.drawLines(),ctx.font="12px minecraft",ctx.textAlign="center";for(var t=0;t<client.entities.length;t++)this.drawEntity(client.entities[t]);ctx.lineWidth=5,ctx.shadowBlur=15,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowColor="#595959",this.drawEntity(client),this.updateCoords(),this.drawManaBar(),this.drawHealthBar(),this.drawAlerts()},Renderer.prototype.garbageLoop=function(){for(var t=0;t<client.entities.length;t++)!(Date.now()-client.entities[t].updated>200);console.log("garbage!"),client.entities.splice(t,1),t--},Renderer.prototype.crds2ctx=function(t){var e=client.x-t.x,n=client.y-t.y;return{x:window.outerWidth/2-e,y:window.outerHeight/2-n}},Renderer.prototype.updateZoom=function(){this.zoom.height=document.documentElement.clientWidth/window.outerWidth,this.zoom.width=document.documentElement.clientHeight/window.outerHeight},Renderer.prototype.resize=function(){this.updateZoom(),ctx.canvas.height=window.innerHeight,ctx.canvas.width=window.innerWidth;var t=document.documentElement.clientWidth/window.outerWidth;console.log(t),ctx.scale(t,t)},CanvasRenderingContext2D.prototype.roundRect=function(t,e,n,i,o,r,c){"undefined"==typeof c&&(c=!0),"undefined"==typeof o&&(o=5),this.beginPath(),this.moveTo(t+o,e),this.lineTo(t+n-o,e),this.quadraticCurveTo(t+n,e,t+n,e+o),this.lineTo(t+n,e+i-o),this.quadraticCurveTo(t+n,e+i,t+n-o,e+i),this.lineTo(t+o,e+i),this.quadraticCurveTo(t,e+i,t,e+i-o),this.lineTo(t,e+o),this.quadraticCurveTo(t,e,t+o,e),this.closePath(),c&&this.stroke(),r&&this.fill()};